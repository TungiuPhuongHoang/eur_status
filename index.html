<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Live EUR rate status</title>
    <!-- Chart.js core -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Luxon (for date handling) -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <!-- Chart.js adapter for Luxon -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
</head>
<body>
<h2>Price status</h2>
<p>Current Price: <span id="currentPrice">-</span></p>
<p>1 EUR = <span id="conversionRate">-</span></p>
<canvas id="liveChart" width="800" height="400"></canvas>

<script>
    const URL = "https://flywire-poller.tungiuphuong.workers.dev/data";
    const STORAGE_KEY = 'chartData';

    // Utility to format number with thousand separators and VND suffix
    function formatVND(amount) {
      return new Intl.NumberFormat('en-US').format(amount) + ' VND';
    }

    // Utility to format numbers with no decimal places
    function formatNumber(num) {
      return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(num);
    }

    const ctx = document.getElementById("liveChart").getContext("2d");
    const chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label: "Price Value",
                data: [],
                fill: false
            }]
        },
        options: {
            scales: {
                x: {
                    type: "time",           // ← needs the adapter!
                    time: {tooltipFormat: "HH:mm:ss"}
                }
            }
        }
    });
    // Load saved chart data from localStorage
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const { labels, data: rawData } = JSON.parse(saved);
      const data = rawData.map(d => d / 10);
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
      if (data.length) {
        const last = data[data.length - 1];
        document.getElementById("currentPrice").innerText = formatVND(last);
        document.getElementById("conversionRate").innerText = formatNumber(last / 12025);
      }
    }

    async function fetchData() {
        try {
            const resp = await fetch(URL);
            const history = await resp.json();            // array of {t: timestamp, v: value}
            // Map history into chart data
            chart.data.labels = history.map(pt => pt.t);
            chart.data.datasets[0].data = history.map(pt => pt.v/10);
            chart.update();
            // Update current price & conversion from last entry
            const last = (history[history.length - 1]?.v ?? 0) / 10;            document.getElementById("currentPrice").innerText = formatVND(last);
            document.getElementById("conversionRate").innerText = formatNumber(last / 12025);
            // Persist updated chart data
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
              labels: chart.data.labels,
              data:   chart.data.datasets[0].data
            }));
        } catch (err) {
            console.error("Polling error:", err);
        }
    }

    fetchData();
    setInterval(fetchData, 120000);
</script>
</body>
</html>